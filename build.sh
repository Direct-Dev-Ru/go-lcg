#!/bin/bash

# ๐ LCG Build Script (Root)
# ะกะบัะธะฟั ะดะปั ัะฑะพัะบะธ ะธะท ะบะพัะฝะตะฒะพะน ะดะธัะตะบัะพัะธะธ ะฟัะพะตะบัะฐ

set -e

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ะคัะฝะบัะธั ะดะปั ะฒัะฒะพะดะฐ ัะพะพะฑัะตะฝะธะน
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

success() {
    echo -e "${GREEN}โ $1${NC}"
}

warning() {
    echo -e "${YELLOW}โ๏ธ  $1${NC}"
}

error() {
    echo -e "${RED}โ $1${NC}"
}

# ะะฐัะฐะผะตััั
REPOSITORY=${1:-"your-registry.com/lcg"}
VERSION=${2:-"latest"}
PLATFORMS=${3:-"linux/amd64,linux/arm64"}

log "๐ ะกะฑะพัะบะฐ LCG ะธะท ะบะพัะฝะตะฒะพะน ะดะธัะตะบัะพัะธะธ..."

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฒ ะบะพัะฝะตะฒะพะน ะดะธัะตะบัะพัะธะธ
if [ ! -f "go.mod" ]; then
    error "ะญัะพั ัะบัะธะฟั ะดะพะปะถะตะฝ ะทะฐะฟััะบะฐัััั ะธะท ะบะพัะฝะตะฒะพะน ะดะธัะตะบัะพัะธะธ ะฟัะพะตะบัะฐ (ะณะดะต ะฝะฐัะพะดะธััั go.mod)"
    exit 1
fi

# ะะฐะฟะธััะฒะฐะตะผ ะฒะตััะธั ะฒ ัะฐะนะป VERSION.txt
echo "$VERSION" > VERSION.txt
log "๐ ะะตััะธั ะทะฐะฟะธัะฐะฝะฐ ะฒ VERSION.txt: $VERSION"

# ะะฐะฟััะบะฐะตะผ ะฟะพะปะฝัั ัะฑะพัะบั
log "๐ ะะฐะฟััะบ ะฟะพะปะฝะพะน ัะฑะพัะบะธ..."
./deploy/full-build.sh "$REPOSITORY" "$VERSION" "$PLATFORMS"

if [ $? -eq 0 ]; then
    success "๐ ะกะฑะพัะบะฐ ะทะฐะฒะตััะตะฝะฐ ััะฟะตัะฝะพ!"
else
    error "ะัะธะฑะบะฐ ะฟัะธ ัะฑะพัะบะต"
    exit 1
fi
